// =============================================================\n// Rommelmarkt in je buurtÂ â€“Â Main.js  (v2025â€‘07â€‘05Â patchâ€‘4)\n// =============================================================\n// Wijzigingen in deze patch\n// -------------------------------------------------------------\n// â€¢Â Elke evenementâ€‘kaart linkt nu naar een eigen detailpagina (event.html?id=...).\n// â€¢Â createMarketCard() gebruikt <a> i.p.v. <div> en krijgt ariaâ€‘label.\n// â€¢Â Heroâ€‘kaarten linken eveneens door.\n// â€¢Â Kleine opschoning + commentaar.\n// -------------------------------------------------------------\n\nimport {\n  auth,\n  provider,\n  db,\n  signInWithPopup,\n  signOut,\n  onAuthStateChanged,\n  collection,\n  addDoc,\n  getDocs,\n  query,\n  orderBy,\n  where,\n  Timestamp,\n  formatDate,\n  formatTime,\n  formatDateTime,\n  eventTypes,\n  adminEmails,\n  deleteDoc,\n  doc\n} from './firebase.js';\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸ”§ Config & helpers\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst DEBUG = true;\nconst MARKET_COLLECTION = 'rommelmarkten';\nconst MARKETS_PER_PAGE = 12;\n\nconst log = (...a)=>DEBUG&&console.log(...a);\nconst debounce=(fn,d=300)=>{let t;return(...x)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(this,x),d);};};\nconst isSameDay=(a,b)=>a.toDateString()===b.toDateString();\nconst convertImageToBase64=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});\nconst showSuccessMessage=m=>{const d=document.createElement('div');d.className='toast-success';d.textContent=m;d.style.cssText='position:fixed;top:16px;right:16px;background:#38a169;color:#fff;padding:10px 16px;border-radius:6px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.15)';document.body.appendChild(d);setTimeout(()=>d.remove(),3000);};\nconst escapeHtml=t=>t.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#039;'}[m]));\nconst getGradientForType=t=>({rommelmarkt:'#48bb78,#38a169',garageverkoop:'#ed8936,#dd6b20',braderie:'#667eea,#764ba2',kermis:'#e53e3e,#c53030',boerenmarkt:'#38a169,#2f855a',antiekmarkt:'#d69e2e,#b7791f',feest:'#9f7aea,#805ad5'}[t]||'#48bb78,#38a169');\nconst animateCounter=(el,to)=>{if(!el)return;const s=0,d=800,st=performance.now();const step=t=>{const p=Math.min((t-st)/d,1);el.textContent=Math.round(s+(to-s)*p);p<1&&requestAnimationFrame(step);};requestAnimationFrame(step);} ;\n\nfunction showErrorState(){marketsContainer&&(marketsContainer.style.display='none');noMarketsDiv&&(noMarketsDiv.style.display='block');loadingMarketsDiv&&(loadingMarketsDiv.style.display='none');}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸ—‚ï¸ State vars\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet allMarkets=[],filteredMarkets=[],currentUser=null,isAdmin=false;\nlet currentView='grid',currentPage=1,hasInitializedMarkets=false;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸ“¦ DOM cache vars\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet loginBtn,logoutBtn,loginContainer,userMenu,userEmail,marketForm,marketsContainer,heroMarketsContainer,noMarketsDiv,filterType,filterLocation,filterDate,clearFiltersBtn,viewGridBtn,viewListBtn,resultsCount,loadingMarketsDiv,loadMoreBtn,loadMoreContainer,suggestEventBtn,totalMarketsSpan,upcomingMarketsSpan,marketImageInput,imagePreview,previewImg,adminPanel,bulkImportForm,bulkDataTextarea,clearAllBtn,importResults;\n\nfunction cacheDom(){loginBtn=document.getElementById('login-btn');logoutBtn=document.getElementById('logout-btn');loginContainer=document.getElementById('login-container');userMenu=document.getElementById('user-menu');userEmail=document.getElementById('user-email');marketForm=document.getElementById('market-form');marketsContainer=document.getElementById('markets-container');heroMarketsContainer=document.getElementById('hero-markets-container');noMarketsDiv=document.getElementById('no-markets');filterType=document.getElementById('filter-type');filterLocation=document.getElementById('filter-location');filterDate=document.getElementById('filter-date');clearFiltersBtn=document.getElementById('clear-filters');viewGridBtn=document.getElementById('view-grid');viewListBtn=document.getElementById('view-list');resultsCount=document.getElementById('results-count');loadingMarketsDiv=document.getElementById('loading-markets');loadMoreBtn=document.getElementById('load-more-btn');loadMoreContainer=document.getElementById('load-more-container');suggestEventBtn=document.getElementById('suggest-event');totalMarketsSpan=document.getElementById('total-markets');upcomingMarketsSpan=document.getElementById('upcoming-markets');marketImageInput=document.getElementById('market-image');imagePreview=document.getElementById('image-preview');previewImg=document.getElementById('preview-img');adminPanel=document.getElementById('admin-panel');bulkImportForm=document.getElementById('bulk-import-form');bulkDataTextarea=document.getElementById('bulk-data');clearAllBtn=document.getElementById('clear-all-btn');importResults=document.getElementById('import-results');}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸš€ Init\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction init(){if(window.__MARKET_APP_INITIALIZED__)return;window.__MARKET_APP_INITIALIZED__=true;cacheDom();setupEventListeners();updateStats();setTimeout(()=>{!hasInitializedMarkets&&loadMarketsPublic();},600);}document.addEventListener('DOMContentLoaded',init);\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸŽ§ Listeners\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction setupEventListeners(){loginBtn&&loginBtn.addEventListener('click',handleLogin);logoutBtn&&logoutBtn.addEventListener('click',()=>signOut(auth));document.querySelectorAll('.nav-login-btn,.show-login').forEach(b=>b.addEventListener('click',e=>{e.preventDefault();showLoginInterface();}));marketForm&&marketForm.addEventListener('submit',handleAddMarket);marketImageInput&&marketImageInput.addEventListener('change',handleImageUpload);filterType&&filterType.addEventListener('change',applyFilters);filterLocation&&filterLocation.addEventListener('input',debounce(applyFilters,300));filterDate&&filterDate.addEventListener('change',applyFilters);clearFiltersBtn&&clearFiltersBtn.addEventListener('click',clearFilters);viewGridBtn&&viewGridBtn.addEventListener('click',()=>switchView('grid'));viewListBtn&&viewListBtn.addEventListener('click',()=>switchView('list'));loadMoreBtn&&loadMoreBtn.addEventListener('click',()=>{currentPage++;renderMarkets();});}\n\nfunction showLoginInterface(){currentUser?document.getElementById('toevoegen')?.scrollIntoView({behavior:'smooth'}):loginContainer&&(loginContainer.style.display='flex');}\nasync function handleLogin(){if(!loginBtn)return;try{loginBtn.disabled=true;loginBtn.textContent='â³ Inloggen...';provider.setCustomParameters({prompt:'select_account'});await signInWithPopup(auth,provider);}catch(e){alert('Kon niet inloggen');log(e);}finally{loginBtn.disabled=false;loginBtn.textContent='ðŸ” Inloggen met Google';loginContainer&&(loginContainer.style.display='none');}}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸ†• Stubs & auth observer\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction handleAddMarket(e){e.preventDefault();alert('Evenement toevoegen is binnenkort beschikbaar.');}\nfunction handleImageUpload(){/* todo */}\n\nonAuthStateChanged(auth,u=>{currentUser=u;isAdmin=!!u&&adminEmails.includes(u.email);userMenu&&(userMenu.style.display=u?'flex':'none');document.querySelectorAll('.nav-login-btn,.show-login').forEach(b=>b.style.display=u?'none':'');userEmail&&(userEmail.textContent=u?.email||'');adminPanel&&(adminPanel.style.display=isAdmin?'block':'none');u?loadMarkets():(!hasInitializedMarkets&&loadMarketsPublic());});\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸ—„ï¸ Dataâ€‘loaders\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nasync function loadMarketsPublic(){hasInitializedMarkets=true;await genericLoadMarkets(true);}async function loadMarkets(){hasInitializedMarkets=true;await genericLoadMarkets(false);} \n\nasync function genericLoadMarkets(isPublic){try{showLoadingState();const q=query(collection(db,MARKET_COLLECTION),orderBy('datumStart','asc'));await fetchAndProcess(q);}catch(e){if(e.code==='failed-precondition'){log('âš ï¸Â Index ontbreekt â€“ fallback op toegevoegdOp');const q2=query(collection(db,MARKET_COLLECTION),orderBy('toegevoegdOp','desc'));await fetchAndProcess(q2);}else{log(e);showErrorState();}}}\n\nasync function fetchAndProcess(q){const snap=await getDocs(q);const map=new Map();snap.forEach(d=>{const m={id:d.id,...d.data()};const key=`${m.naam}-${m.locatie}-${m.datumStart.toDate().toDateString()}`;map.has(key)||map.set(key,m);});allMarkets=[...map.values()].sort((a,b)=>a.datumStart.toDate()-b.datumStart.toDate());currentPage=1;applyFilters();updateStats();loadHeroMarkets();loadingMarketsDiv&&(loadingMarketsDiv.style.display='none');}\n\nfunction showLoadingState(){loadingMarketsDiv&&(loadingMarketsDiv.style.display='block');marketsContainer&&(marketsContainer.style.display='none');noMarketsDiv&&(noMarketsDiv.style.display='none');loadMoreContainer&&(loadMoreContainer.style.display='none');}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸ” Filtering\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction applyFilters(){if(!allMarkets)return;const t=filterType?.value.toLowerCase()||'';const l=filterLocation?.value.toLowerCase()||'';const d=filterDate?.value||'';filteredMarkets=allMarkets.filter(m=>{if(t&&m.type!==t)return false;if(l&&!(`${m.locatie} ${m.naam} ${m.organisator||''}`.toLowerCase().includes(l)))return false;if(d){const md=m.datumStart.toDate();const now=new Date();switch(d){case 'today':if(!isSameDay(md,now))return false;break;case 'tomorrow':const tm=new Date(now);tm.setDate(now.getDate()+1);if(!isSameDay(md,tm))return false;break;case 'week':{const end=new Date(now);end.setDate(now.getDate()+7);if(md<now||md>end)return false;}break;case 'weekend':{const day=md.getDay();if(day!==0&&day!==6)return false;}break;case 'month':if(md.getMonth()!==now.getMonth()||md.getFullYear()!==now.getFullYear())return false;break;case 'future':if(md<now)return false;break;}}return true;});currentPage=1;renderMarkets();}\n\nfunction clearFilters(){filterType&&(filterType.value='');filterLocation&&(filterLocation.value='');filterDate&&(filterDate.value='');applyFilters();}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ðŸ“¤ Rendering\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction renderMarkets(){if(!marketsContainer)return;loadingMarketsDiv&&(loadingMarketsDiv.style.display='none');const start=(currentPage-1)*MARKETS_PER_PAGE;const items=filteredMarkets.slice(start,start+MARKETS_PER_PAGE);\n  if(!items.length){noMarketsDiv&&(noMarketsDiv.style.display='block');marketsContainer.style.display='none';resultsCount&&(resultsCount.textContent='0 evenementen gevonden');loadMoreContainer&&(loadMoreContainer.style.display='none');return;}\n  noMarketsDiv&&(noMarketsDiv.style.display='none');marketsContainer.style.display=currentView==='grid'?'grid':'block';marketsContainer.innerHTML='';items.forEach(m=>marketsContainer.appendChild(createMarketCard(m)));\n  if(resultsCount){const c=filteredMarkets.length;resultsCount.textContent=`${c} evenement${c!==1?'en':''} gevonden`;}\n  loadMoreContainer&&(loadMoreContainer.style.display=(filteredMarkets.length>currentPage*MARKETS_PER_PAGE?'block':'none'));}\n\nfunction createMarketCard(m){const card=document.createElement('a');card.className='market-card';card.href=`event.html?id=${m.id}`;card.setAttribute('aria-label',m.naam);\n  const evt=eventTypes[m.type]||eventTypes.rommelmarkt;const dateObj=formatDateTime(m.datumStart);const hasImg=!!m.imageUrl;\n  card.innerHTML=`${hasImg?`<img src="${m.imageUrl}" alt="${escapeHtml(m.naam)}" class="market-image" loading="lazy">`:`<div class="market-image" style="background:linear-gradient(135deg,${getGradientForType(m.type)});display:flex;align-items:center;justify-content:center;font-size:2rem;color:#fff;">${evt.icon}</div>`}`+\n    `<div class="market-card-content"><div class="market-type-badge type-${m.type}">${evt.icon} ${evt.label}</div>`+\n    `<h3>${escapeHtml(m.naam)}</h3><p style="color:#555;font-size:0.875rem;">${dateObj.dayName} â€¢ ${dateObj.time}</p>`+\n    `<p style="color:#777;font-size:0.75rem;">${escapeHtml(m.locatie)}</p></div>`;\n  return card;}\n\nfunction switchView(v){currentView=v;viewGridBtn&&(viewGridBtn.classList.toggle('active',v==='grid'));viewListBtn&&(viewListBtn.classList.toggle('active',v==='list'));renderMarkets();}\n\nfunction loadHeroMarkets(){if(!heroMarketsContainer)return;const upcoming=allMarkets.filter(m=>m.datumStart.toDate()>new Date()).slice(0,3);heroMarketsContainer.innerHTML='';upcoming.forEach(m=>{const evt=eventTypes[m.type]||eventTypes.rommelmarkt;const card=document.createElement('a');card.className='market-card';card.href=`event.html?id=${m.id}`;card.innerHTML=`<div style="padding:12px;text-align:center;background:linear-gradient(135deg,${getGradientForType(m.type)});color:#fff;"><strong>${escapeHtml(m.naam)}</strong><br><small>${formatDateTime(m.datumStart).dayName}</small><div style="font-size:1.5rem;margin-top:4px;">${evt.icon}</div></div>`;heroMarketsContainer.appendChild(card);});}\n\nfunction updateStats(){if(!totalMarketsSpan||!upcomingMarketsSpan)return;const now=new Date();const monthEnd=new Date(now.getFullYear(),now.getMonth()+1,0);const weekEnd=new Date(now);weekEnd.setDate(now.getDate()+7);const inMonth=allMarkets.filter(m=>{const d=m.datumStart.toDate();return d>=now&&d<=monthEnd;}).length;const inWeek=allMarkets.filter(m=>{const d=m.datumStart.toDate();return d>=now&&d<=weekEnd;}).length;animateCounter(totalMarketsSpan,inMonth);animateCounter(upcomingMarketsSpan,inWeek);}
